"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AWSAdapterStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_apigatewayv2_alpha_1 = require("@aws-cdk/aws-apigatewayv2-alpha");
const aws_apigatewayv2_integrations_alpha_1 = require("@aws-cdk/aws-apigatewayv2-integrations-alpha");
const dotenv_1 = require("dotenv");
class AWSAdapterStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        var _a, _b, _c;
        super(scope, id, props);
        const routes = ((_a = process.env.ROUTES) === null || _a === void 0 ? void 0 : _a.split(',')) || [];
        const projectPath = process.env.PROJECT_PATH;
        const serverPath = process.env.SERVER_PATH;
        const staticPath = process.env.STATIC_PATH;
        const prerenderedPath = process.env.PRERENDERED_PATH;
        const logRetention = parseInt(process.env.LOG_RETENTION_DAYS) || 7;
        const memorySize = parseInt(process.env.MEMORY_SIZE) || 128;
        const environment = (0, dotenv_1.config)({ path: projectPath });
        const [_, zoneName, ...MLDs] = ((_b = process.env.FQDN) === null || _b === void 0 ? void 0 : _b.split('.')) || [];
        const domainName = [zoneName, ...MLDs].join(".");
        this.serverHandler = new aws_cdk_lib_1.aws_lambda.Function(this, 'LambdaServerFunctionHandler', {
            code: new aws_cdk_lib_1.aws_lambda.AssetCode(serverPath),
            handler: 'index.handler',
            runtime: aws_cdk_lib_1.aws_lambda.Runtime.NODEJS_20_X,
            timeout: aws_cdk_lib_1.Duration.minutes(15),
            memorySize,
            logRetention,
            environment: Object.assign({}, environment.parsed),
        });
        (_c = props.serverHandlerPolicies) === null || _c === void 0 ? void 0 : _c.forEach((policy) => this.serverHandler.addToRolePolicy(policy));
        this.httpApi = new aws_apigatewayv2_alpha_1.HttpApi(this, 'API', {
            corsPreflight: {
                allowHeaders: ['*'],
                allowMethods: [aws_apigatewayv2_alpha_1.CorsHttpMethod.ANY],
                allowOrigins: ['*'],
                maxAge: aws_cdk_lib_1.Duration.days(1),
            },
            defaultIntegration: new aws_apigatewayv2_integrations_alpha_1.HttpLambdaIntegration('LambdaServerIntegration', this.serverHandler, {
                payloadFormatVersion: aws_apigatewayv2_alpha_1.PayloadFormatVersion.VERSION_1_0,
            }),
        });
        this.bucket = new aws_cdk_lib_1.aws_s3.Bucket(this, 'StaticContentBucket', {
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
            autoDeleteObjects: true,
        });
        if (process.env.FQDN) {
            this.hostedZone = aws_cdk_lib_1.aws_route53.HostedZone.fromLookup(this, 'HostedZone', {
                domainName,
            });
            this.certificate = new aws_cdk_lib_1.aws_certificatemanager.DnsValidatedCertificate(this, 'DnsValidatedCertificate', {
                domainName: process.env.FQDN,
                hostedZone: this.hostedZone,
                region: 'us-east-1',
            });
        }
        const distribution = new aws_cdk_lib_1.aws_cloudfront.Distribution(this, 'CloudFrontDistribution', {
            priceClass: aws_cdk_lib_1.aws_cloudfront.PriceClass.PRICE_CLASS_100,
            enabled: true,
            defaultRootObject: '',
            sslSupportMethod: aws_cdk_lib_1.aws_cloudfront.SSLMethod.SNI,
            domainNames: process.env.FQDN ? [process.env.FQDN] : [],
            certificate: process.env.FQDN
                ? aws_cdk_lib_1.aws_certificatemanager.Certificate.fromCertificateArn(this, 'DomainCertificate', this.certificate.certificateArn)
                : undefined,
            defaultBehavior: {
                compress: true,
                origin: new aws_cdk_lib_1.aws_cloudfront_origins.HttpOrigin(aws_cdk_lib_1.Fn.select(1, aws_cdk_lib_1.Fn.split('://', this.httpApi.apiEndpoint)), {
                    protocolPolicy: aws_cdk_lib_1.aws_cloudfront.OriginProtocolPolicy.HTTPS_ONLY,
                }),
                viewerProtocolPolicy: aws_cdk_lib_1.aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                allowedMethods: aws_cdk_lib_1.aws_cloudfront.AllowedMethods.ALLOW_ALL,
                originRequestPolicy: new aws_cdk_lib_1.aws_cloudfront.OriginRequestPolicy(this, 'OriginRequestPolicy', {
                    cookieBehavior: aws_cdk_lib_1.aws_cloudfront.OriginRequestCookieBehavior.all(),
                    queryStringBehavior: aws_cdk_lib_1.aws_cloudfront.OriginRequestQueryStringBehavior.all(),
                    headerBehavior: aws_cdk_lib_1.aws_cloudfront.OriginRequestHeaderBehavior.allowList('Origin', 'Accept-Charset', 'Accept', 'Access-Control-Request-Method', 'Access-Control-Request-Headers', 'Referer', 'Accept-Language', 'Accept-Datetime'),
                }),
                cachePolicy: aws_cdk_lib_1.aws_cloudfront.CachePolicy.CACHING_DISABLED,
            },
        });
        const s3Origin = new aws_cdk_lib_1.aws_cloudfront_origins.S3Origin(this.bucket, {});
        routes.forEach((route) => {
            distribution.addBehavior(route, s3Origin, {
                viewerProtocolPolicy: aws_cdk_lib_1.aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                allowedMethods: aws_cdk_lib_1.aws_cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                originRequestPolicy: aws_cdk_lib_1.aws_cloudfront.OriginRequestPolicy.USER_AGENT_REFERER_HEADERS,
                cachePolicy: aws_cdk_lib_1.aws_cloudfront.CachePolicy.CACHING_OPTIMIZED,
            });
        });
        if (process.env.FQDN) {
            new aws_cdk_lib_1.aws_route53.ARecord(this, 'ARecord', {
                recordName: process.env.FQDN,
                target: aws_cdk_lib_1.aws_route53.RecordTarget.fromAlias(new aws_cdk_lib_1.aws_route53_targets.CloudFrontTarget(distribution)),
                zone: this.hostedZone,
            });
        }
        new aws_cdk_lib_1.aws_s3_deployment.BucketDeployment(this, 'StaticContentDeployment', {
            destinationBucket: this.bucket,
            sources: [aws_cdk_lib_1.aws_s3_deployment.Source.asset(staticPath), aws_cdk_lib_1.aws_s3_deployment.Source.asset(prerenderedPath)],
            retainOnDelete: false,
            prune: true,
            distribution,
            distributionPaths: ['/*'],
        });
        new aws_cdk_lib_1.CfnOutput(this, 'appUrl', {
            value: process.env.FQDN ? `https://${process.env.FQDN}` : `https://${distribution.domainName}`,
        });
        new aws_cdk_lib_1.CfnOutput(this, 'stackName', { value: id });
    }
}
exports.AWSAdapterStack = AWSAdapterStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFkYXB0ZXItc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsNkNBZXFCO0FBQ3JCLDRFQUEwRztBQUMxRyxzR0FBcUY7QUFDckYsbUNBQWdDO0FBV2hDLE1BQWEsZUFBZ0IsU0FBUSxtQkFBSztJQU94QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQTJCOztRQUNuRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLE1BQU0sR0FBRyxDQUFBLE1BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLDBDQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSSxFQUFFLENBQUM7UUFDcEQsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7UUFDN0MsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQztRQUNyRCxNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFZLENBQUMsSUFBSSxHQUFHLENBQUM7UUFDN0QsTUFBTSxXQUFXLEdBQUcsSUFBQSxlQUFNLEVBQUMsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNsRCxNQUFNLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUEsTUFBQSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUks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QUMsSUFBSSxFQUFFLFFBQVEsRUFBRTtZQUM1QixLQUFLLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFdBQVcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxZQUFZLENBQUMsVUFBVSxFQUFFO1NBQy9GLENBQUMsQ0FBQztRQUVILElBQUksdUJBQVMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbEQsQ0FBQztDQUNGO0FBdklELDBDQXVJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgU3RhY2tQcm9wcyxcbiAgU3RhY2ssXG4gIEZuLFxuICBSZW1vdmFsUG9saWN5LFxuICBEdXJhdGlvbixcbiAgQ2ZuT3V0cHV0LFxuICBhd3NfbGFtYmRhLFxuICBhd3NfczMsXG4gIGF3c19zM19kZXBsb3ltZW50LFxuICBhd3NfY2xvdWRmcm9udF9vcmlnaW5zLFxuICBhd3NfY2VydGlmaWNhdGVtYW5hZ2VyLFxuICBhd3Nfcm91dGU1MyxcbiAgYXdzX3JvdXRlNTNfdGFyZ2V0cyxcbiAgYXdzX2Nsb3VkZnJvbnQsXG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENvcnNIdHRwTWV0aG9kLCBIdHRwQXBpLCBJSHR0cEFwaSwgUGF5bG9hZEZvcm1hdFZlcnNpb24gfSBmcm9tICdAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyLWFscGhhJztcbmltcG9ydCB7IEh0dHBMYW1iZGFJbnRlZ3JhdGlvbiB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zLWFscGhhJztcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJ2RvdGVudic7XG5pbXBvcnQgeyBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcblxuZXhwb3J0IGludGVyZmFjZSBBV1NBZGFwdGVyU3RhY2tQcm9wcyBleHRlbmRzIFN0YWNrUHJvcHMge1xuICBGUUROOiBzdHJpbmc7XG4gIGFjY291bnQ/OiBzdHJpbmc7XG4gIHJlZ2lvbj86IHN0cmluZztcbiAgc2VydmVySGFuZGxlclBvbGljaWVzPzogUG9saWN5U3RhdGVtZW50W107XG4gIHpvbmVOYW1lPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgQVdTQWRhcHRlclN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICBidWNrZXQ6IGF3c19zMy5JQnVja2V0O1xuICBzZXJ2ZXJIYW5kbGVyOiBhd3NfbGFtYmRhLklGdW5jdGlvbjtcbiAgaHR0cEFwaTogSUh0dHBBcGk7XG4gIGhvc3RlZFpvbmU6IGF3c19yb3V0ZTUzLklIb3N0ZWRab25lO1xuICBjZXJ0aWZpY2F0ZTogYXdzX2NlcnRpZmljYXRlbWFuYWdlci5JQ2VydGlmaWNhdGU7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEFXU0FkYXB0ZXJTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCByb3V0ZXMgPSBwcm9jZXNzLmVudi5ST1VURVM/LnNwbGl0KCcsJykgfHwgW107XG4gICAgY29uc3QgcHJvamVjdFBhdGggPSBwcm9jZXNzLmVudi5QUk9KRUNUX1BBVEg7XG4gICAgY29uc3Qgc2VydmVyUGF0aCA9IHByb2Nlc3MuZW52LlNFUlZFUl9QQVRIO1xuICAgIGNvbnN0IHN0YXRpY1BhdGggPSBwcm9jZXNzLmVudi5TVEFUSUNfUEFUSDtcbiAgICBjb25zdCBwcmVyZW5kZXJlZFBhdGggPSBwcm9jZXNzLmVudi5QUkVSRU5ERVJFRF9QQVRIO1xuICAgIGNvbnN0IGxvZ1JldGVudGlvbiA9IHBhcnNlSW50KHByb2Nlc3MuZW52LkxPR19SRVRFTlRJT05fREFZUyEpIHx8IDc7XG4gICAgY29uc3QgbWVtb3J5U2l6ZSA9IHBhcnNlSW50KHByb2Nlc3MuZW52Lk1FTU9SWV9TSVpFISkgfHwgMTI4O1xuICAgIGNvbnN0IGVudmlyb25tZW50ID0gY29uZmlnKHsgcGF0aDogcHJvamVjdFBhdGggfSk7XG4gICAgY29uc3QgW18sIHpvbmVOYW1lLCAuLi5NTERzXSA9IHByb2Nlc3MuZW52LkZRRE4/LnNwbGl0KCcuJykgfHwgW107XG4gICAgY29uc3QgZG9tYWluTmFtZSA9IFt6b25lTmFtZSwgLi4uTUxEc10uam9pbihcIi5cIik7XG5cbiAgICB0aGlzLnNlcnZlckhhbmRsZXIgPSBuZXcgYXdzX2xhbWJkYS5GdW5jdGlvbih0aGlzLCAnTGFtYmRhU2VydmVyRnVuY3Rpb25IYW5kbGVyJywge1xuICAgICAgY29kZTogbmV3IGF3c19sYW1iZGEuQXNzZXRDb2RlKHNlcnZlclBhdGghKSxcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IGF3c19sYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZSxcbiAgICAgIGxvZ1JldGVudGlvbixcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIC4uLmVudmlyb25tZW50LnBhcnNlZCxcbiAgICAgIH0gYXMgYW55LFxuICAgIH0pO1xuXG4gICAgcHJvcHMuc2VydmVySGFuZGxlclBvbGljaWVzPy5mb3JFYWNoKChwb2xpY3kpID0+IHRoaXMuc2VydmVySGFuZGxlci5hZGRUb1JvbGVQb2xpY3kocG9saWN5KSk7XG5cbiAgICB0aGlzLmh0dHBBcGkgPSBuZXcgSHR0cEFwaSh0aGlzLCAnQVBJJywge1xuICAgICAgY29yc1ByZWZsaWdodDoge1xuICAgICAgICBhbGxvd0hlYWRlcnM6IFsnKiddLFxuICAgICAgICBhbGxvd01ldGhvZHM6IFtDb3JzSHR0cE1ldGhvZC5BTlldLFxuICAgICAgICBhbGxvd09yaWdpbnM6IFsnKiddLFxuICAgICAgICBtYXhBZ2U6IER1cmF0aW9uLmRheXMoMSksXG4gICAgICB9LFxuICAgICAgZGVmYXVsdEludGVncmF0aW9uOiBuZXcgSHR0cExhbWJkYUludGVncmF0aW9uKCdMYW1iZGFTZXJ2ZXJJbnRlZ3JhdGlvbicsIHRoaXMuc2VydmVySGFuZGxlciwge1xuICAgICAgICBwYXlsb2FkRm9ybWF0VmVyc2lvbjogUGF5bG9hZEZvcm1hdFZlcnNpb24uVkVSU0lPTl8xXzAsXG4gICAgICB9KSxcbiAgICB9KTtcblxuICAgIHRoaXMuYnVja2V0ID0gbmV3IGF3c19zMy5CdWNrZXQodGhpcywgJ1N0YXRpY0NvbnRlbnRCdWNrZXQnLCB7XG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGlmIChwcm9jZXNzLmVudi5GUUROKSB7XG4gICAgICB0aGlzLmhvc3RlZFpvbmUgPSBhd3Nfcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgJ0hvc3RlZFpvbmUnLCB7XG4gICAgICAgIGRvbWFpbk5hbWUsXG4gICAgICB9KSBhcyBhd3Nfcm91dGU1My5Ib3N0ZWRab25lO1xuXG4gICAgICB0aGlzLmNlcnRpZmljYXRlID0gbmV3IGF3c19jZXJ0aWZpY2F0ZW1hbmFnZXIuRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGUodGhpcywgJ0Ruc1ZhbGlkYXRlZENlcnRpZmljYXRlJywge1xuICAgICAgICBkb21haW5OYW1lOiBwcm9jZXNzLmVudi5GUUROISxcbiAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICByZWdpb246ICd1cy1lYXN0LTEnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZGlzdHJpYnV0aW9uID0gbmV3IGF3c19jbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCAnQ2xvdWRGcm9udERpc3RyaWJ1dGlvbicsIHtcbiAgICAgIHByaWNlQ2xhc3M6IGF3c19jbG91ZGZyb250LlByaWNlQ2xhc3MuUFJJQ0VfQ0xBU1NfMTAwLFxuICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgIGRlZmF1bHRSb290T2JqZWN0OiAnJyxcbiAgICAgIHNzbFN1cHBvcnRNZXRob2Q6IGF3c19jbG91ZGZyb250LlNTTE1ldGhvZC5TTkksXG4gICAgICBkb21haW5OYW1lczogcHJvY2Vzcy5lbnYuRlFETiA/IFtwcm9jZXNzLmVudi5GUUROIV0gOiBbXSxcbiAgICAgIGNlcnRpZmljYXRlOiBwcm9jZXNzLmVudi5GUUROXG4gICAgICAgID8gYXdzX2NlcnRpZmljYXRlbWFuYWdlci5DZXJ0aWZpY2F0ZS5mcm9tQ2VydGlmaWNhdGVBcm4oXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgJ0RvbWFpbkNlcnRpZmljYXRlJyxcbiAgICAgICAgICAgIHRoaXMuY2VydGlmaWNhdGUuY2VydGlmaWNhdGVBcm5cbiAgICAgICAgICApXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgZGVmYXVsdEJlaGF2aW9yOiB7XG4gICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICBvcmlnaW46IG5ldyBhd3NfY2xvdWRmcm9udF9vcmlnaW5zLkh0dHBPcmlnaW4oRm4uc2VsZWN0KDEsIEZuLnNwbGl0KCc6Ly8nLCB0aGlzLmh0dHBBcGkuYXBpRW5kcG9pbnQpKSwge1xuICAgICAgICAgIHByb3RvY29sUG9saWN5OiBhd3NfY2xvdWRmcm9udC5PcmlnaW5Qcm90b2NvbFBvbGljeS5IVFRQU19PTkxZLFxuICAgICAgICB9KSxcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3k6IGF3c19jbG91ZGZyb250LlZpZXdlclByb3RvY29sUG9saWN5LlJFRElSRUNUX1RPX0hUVFBTLFxuICAgICAgICBhbGxvd2VkTWV0aG9kczogYXdzX2Nsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfQUxMLFxuICAgICAgICBvcmlnaW5SZXF1ZXN0UG9saWN5OiBuZXcgYXdzX2Nsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdFBvbGljeSh0aGlzLCAnT3JpZ2luUmVxdWVzdFBvbGljeScsIHtcbiAgICAgICAgICBjb29raWVCZWhhdmlvcjogYXdzX2Nsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdENvb2tpZUJlaGF2aW9yLmFsbCgpLFxuICAgICAgICAgIHF1ZXJ5U3RyaW5nQmVoYXZpb3I6IGF3c19jbG91ZGZyb250Lk9yaWdpblJlcXVlc3RRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgICAgICAgIGhlYWRlckJlaGF2aW9yOiBhd3NfY2xvdWRmcm9udC5PcmlnaW5SZXF1ZXN0SGVhZGVyQmVoYXZpb3IuYWxsb3dMaXN0KFxuICAgICAgICAgICAgJ09yaWdpbicsXG4gICAgICAgICAgICAnQWNjZXB0LUNoYXJzZXQnLFxuICAgICAgICAgICAgJ0FjY2VwdCcsXG4gICAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtUmVxdWVzdC1NZXRob2QnLFxuICAgICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLVJlcXVlc3QtSGVhZGVycycsXG4gICAgICAgICAgICAnUmVmZXJlcicsXG4gICAgICAgICAgICAnQWNjZXB0LUxhbmd1YWdlJyxcbiAgICAgICAgICAgICdBY2NlcHQtRGF0ZXRpbWUnXG4gICAgICAgICAgKSxcbiAgICAgICAgfSksXG4gICAgICAgIGNhY2hlUG9saWN5OiBhd3NfY2xvdWRmcm9udC5DYWNoZVBvbGljeS5DQUNISU5HX0RJU0FCTEVELFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHMzT3JpZ2luID0gbmV3IGF3c19jbG91ZGZyb250X29yaWdpbnMuUzNPcmlnaW4odGhpcy5idWNrZXQsIHt9KTtcbiAgICByb3V0ZXMuZm9yRWFjaCgocm91dGUpID0+IHtcbiAgICAgIGRpc3RyaWJ1dGlvbi5hZGRCZWhhdmlvcihyb3V0ZSwgczNPcmlnaW4sIHtcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3k6IGF3c19jbG91ZGZyb250LlZpZXdlclByb3RvY29sUG9saWN5LlJFRElSRUNUX1RPX0hUVFBTLFxuICAgICAgICBhbGxvd2VkTWV0aG9kczogYXdzX2Nsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgb3JpZ2luUmVxdWVzdFBvbGljeTogYXdzX2Nsb3VkZnJvbnQuT3JpZ2luUmVxdWVzdFBvbGljeS5VU0VSX0FHRU5UX1JFRkVSRVJfSEVBREVSUyxcbiAgICAgICAgY2FjaGVQb2xpY3k6IGF3c19jbG91ZGZyb250LkNhY2hlUG9saWN5LkNBQ0hJTkdfT1BUSU1JWkVELFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpZiAocHJvY2Vzcy5lbnYuRlFETikge1xuICAgICAgbmV3IGF3c19yb3V0ZTUzLkFSZWNvcmQodGhpcywgJ0FSZWNvcmQnLCB7XG4gICAgICAgIHJlY29yZE5hbWU6IHByb2Nlc3MuZW52LkZRRE4sXG4gICAgICAgIHRhcmdldDogYXdzX3JvdXRlNTMuUmVjb3JkVGFyZ2V0LmZyb21BbGlhcyhuZXcgYXdzX3JvdXRlNTNfdGFyZ2V0cy5DbG91ZEZyb250VGFyZ2V0KGRpc3RyaWJ1dGlvbikpLFxuICAgICAgICB6b25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBuZXcgYXdzX3MzX2RlcGxveW1lbnQuQnVja2V0RGVwbG95bWVudCh0aGlzLCAnU3RhdGljQ29udGVudERlcGxveW1lbnQnLCB7XG4gICAgICBkZXN0aW5hdGlvbkJ1Y2tldDogdGhpcy5idWNrZXQsXG4gICAgICBzb3VyY2VzOiBbYXdzX3MzX2RlcGxveW1lbnQuU291cmNlLmFzc2V0KHN0YXRpY1BhdGghKSwgYXdzX3MzX2RlcGxveW1lbnQuU291cmNlLmFzc2V0KHByZXJlbmRlcmVkUGF0aCEpXSxcbiAgICAgIHJldGFpbk9uRGVsZXRlOiBmYWxzZSxcbiAgICAgIHBydW5lOiB0cnVlLFxuICAgICAgZGlzdHJpYnV0aW9uLFxuICAgICAgZGlzdHJpYnV0aW9uUGF0aHM6IFsnLyonXSxcbiAgICB9KTtcblxuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgJ2FwcFVybCcsIHtcbiAgICAgIHZhbHVlOiBwcm9jZXNzLmVudi5GUUROID8gYGh0dHBzOi8vJHtwcm9jZXNzLmVudi5GUUROfWAgOiBgaHR0cHM6Ly8ke2Rpc3RyaWJ1dGlvbi5kb21haW5OYW1lfWAsXG4gICAgfSk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsICdzdGFja05hbWUnLCB7IHZhbHVlOiBpZCB9KTtcbiAgfVxufVxuIl19